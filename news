# app.py
# Bright as News — Python Flask full app (single-file)
# Made by Sahitya. 2026
#
# Uses NewsData API (server-side) to fetch live news and serve to the browser.
# API Key used below: pub_a68f325782994d9eb614b14fedf6c9af

from flask import Flask, jsonify, request, render_template_string
import requests
import traceback
import datetime

app = Flask(__name__)

# ---------------------------
# CONFIG
# ---------------------------
NEWSDATA_API_KEY = "pub_a68f325782994d9eb614b14fedf6c9af"
NEWSDATA_ENDPOINT = "https://newsdata.io/api/1/news"
# You may change refresh interval on client side (in JS) if needed.
# ---------------------------

# ---------------------------
# HTML Template (single string)
# Contains embedded CSS and JS so this is one-file deployment.
# ---------------------------
HTML_TEMPLATE = r'''
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bright as News — Live</title>

  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent:#ff7f50;
      --accent-dark:#ff4500;
      --bg1: #fff9f0;
      --bg2: #fffefb;
      --card: #fffbea;
      --muted:#555;
      --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Poppins',sans-serif;
      background: linear-gradient(135deg, #ffefba 0%, #ffffff 100%);
      color:#222;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    header{
      background: linear-gradient(90deg, var(--accent) 0%, #ff9f79 100%);
      padding:18px 20px;
      display:flex;
      align-items:center;
      gap:18px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      flex-wrap:wrap;
      justify-content:space-between;
    }
    .brand {
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo {
      width:56px;
      height:56px;
      flex:0 0 56px;
      border-radius:12px;
      background:linear-gradient(135deg,#ffffff66,#ffffff22);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    /* small inline svg logo color */
    .logo svg { width:36px; height:36px; }

    .title {
      font-size:1.3rem;
      font-weight:700;
      color:white;
      text-shadow:0 1px 0 rgba(0,0,0,0.06);
      line-height:1;
    }
    .subtitle {
      font-size:0.82rem;
      color: #fff8;
      margin-top:3px;
      font-weight:500;
    }

    .controls {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .controls select{
      padding:10px 12px;
      border-radius:10px;
      border:none;
      outline:none;
      font-weight:600;
      background:rgba(255,255,255,0.95);
      color:#333;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    .controls button{
      padding:10px 14px;
      border-radius:10px;
      border:none;
      font-weight:600;
      cursor:pointer;
      background: rgba(255,255,255,0.12);
      color: #fff;
      backdrop-filter: blur(4px);
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.06);
    }

    main {
      padding:22px;
      max-width:1200px;
      margin: 18px auto;
    }

    .news-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(300px,1fr));
      gap:18px;
    }

    .card {
      background:var(--card);
      border-radius:14px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(17,17,17,0.06);
      transition: transform 220ms ease, box-shadow 220ms ease;
      display:flex;
      flex-direction:column;
    }
    .card:hover{ transform: translateY(-6px); box-shadow: 0 18px 40px rgba(17,17,17,0.09); }

    .media {
      width:100%;
      height:180px;
      background: linear-gradient(90deg,#f3f3f3,#eaeaea);
      display:block;
      object-fit:cover;
    }

    .card-body {
      padding:14px 16px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:150px;
    }
    .kicker {
      font-size:12px;
      color:var(--accent-dark);
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.06em;
    }
    .headline {
      font-size:1.05rem;
      font-weight:700;
      color:var(--accent-dark);
      line-height:1.2;
    }
    .summary {
      color:var(--muted);
      font-size:0.95rem;
      flex:1;
      overflow:hidden;
    }
    .meta {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-top:10px;
    }
    .read-btn {
      color:var(--accent);
      font-weight:700;
      text-decoration:none;
      padding:8px 10px;
      border-radius:8px;
      background: rgba(255,127,80,0.06);
    }
    .source {
      font-size:12px;
      color:#666;
    }

    .loader {
      text-align:center;
      padding:40px 0;
      color:#666;
    }

    footer {
      margin-top:26px;
      padding:16px 20px;
      text-align:center;
      font-size:0.95rem;
      color:#fff;
      background: linear-gradient(90deg, #ff7f50, #ff945f);
      border-top-left-radius:12px;
      border-top-right-radius:12px;
      max-width:1200px;
      margin-left:auto;margin-right:auto;
    }

    /* small responsive tweaks */
    @media (max-width:480px){
      header{ padding:12px }
      .logo{ width:48px;height:48px }
      .title{ font-size:1rem }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <!-- inline SVG bright icon -->
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" x2="1">
              <stop offset="0" stop-color="#fff"/>
              <stop offset="1" stop-color="#ffd1b8"/>
            </linearGradient>
          </defs>
          <rect x="2" y="3" width="20" height="14" rx="3" fill="#fff" opacity="0.06"/>
          <path d="M3 7c0-1.1.9-2 2-2h9" stroke="#fff" stroke-opacity="0.9" stroke-width="1.2" fill="none"/>
          <circle cx="18" cy="7" r="3" fill="#fff" opacity="0.18"/>
          <path d="M6 14v4" stroke="#ff7f50" stroke-width="1.6" stroke-linecap="round"/>
          <path d="M10 14v6" stroke="#ff4500" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <div class="title">Bright as News</div>
        <div class="subtitle">Live world headlines — fresh & bright</div>
      </div>
    </div>

    <div class="controls" aria-hidden="false">
      <select id="categorySelect" aria-label="Choose news category">
        <option value="top">Top</option>
        <option value="business">Business</option>
        <option value="technology">Technology</option>
        <option value="sports">Sports</option>
        <option value="science">Science</option>
      </select>
      <button id="refreshBtn" title="Refresh now">Refresh</button>
    </div>
  </header>

  <main>
    <div id="newsRoot" class="news-grid" aria-live="polite">
      <!-- cards inserted here -->
    </div>

    <div id="loader" class="loader" style="display:none">Loading latest news...</div>
  </main>

  <footer>
    Bright as News — Made by Sahitya. 2026
  </footer>

  <script>
    // client-side JS: calls our Python endpoint /api/news
    const root = document.getElementById('newsRoot');
    const loader = document.getElementById('loader');
    const select = document.getElementById('categorySelect');
    const refreshBtn = document.getElementById('refreshBtn');

    let currentCategory = 'top';
    let fetchInProgress = false;

    async function renderArticles(articles){
      root.innerHTML = '';
      if(!articles || articles.length === 0){
        root.innerHTML = '<div style="padding:32px;text-align:center;color:#666">No news available right now.</div>';
        return;
      }

      articles.forEach(a => {
        const img = a.image_url || a.image || ('https://via.placeholder.com/640x360?text=Bright+News');
        const source = a.source_id || a.source || a.creator || 'Source';
        const title = a.title || 'Untitled';
        const description = a.description || a.summary || '';
        const link = a.link || a.url || '#';

        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <img class="media" src="${img}" alt="${escapeHtml(title)}">
          <div class="card-body">
            <div class="kicker">${escapeHtml(source)}</div>
            <div class="headline">${escapeHtml(title)}</div>
            <div class="summary">${escapeHtml(description)}</div>
            <div class="meta">
              <a class="read-btn" href="${link}" target="_blank" rel="noopener">Read More →</a>
              <div class="source">${escapeHtml(formatTime(a.pubDate || a.pubDateIso || a.pubDate_z || ''))}</div>
            </div>
          </div>
        `;
        root.appendChild(card);
      });
    }

    function escapeHtml(s){
      if(!s) return '';
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;');
    }

    function formatTime(t){
      if(!t) return '';
      try {
        const d = new Date(t);
        if(isNaN(d)) return '';
        return d.toLocaleString();
      } catch { return ''; }
    }

    async function fetchNews(){
      if(fetchInProgress) return;
      fetchInProgress = true;
      loader.style.display = '';
      try {
        const resp = await fetch(`/api/news?category=${encodeURIComponent(currentCategory)}&limit=12`);
        if(!resp.ok) throw new Error('network');
        const j = await resp.json();
        const articles = j.articles || j.results || [];
        await renderArticles(articles);
      } catch (err) {
        root.innerHTML = '<div style="padding:32px;text-align:center;color:#b33">Error loading news. Try Refresh.</div>';
        console.error(err);
      } finally {
        loader.style.display = 'none';
        fetchInProgress = false;
      }
    }

    // initial load
    fetchNews();

    // auto refresh every 30 seconds
    setInterval(fetchNews, 30000);

    // category change
    select.addEventListener('change', (e)=>{
      currentCategory = e.target.value;
      fetchNews();
    });

    // manual refresh
    refreshBtn.addEventListener('click', ()=> fetchNews());
  </script>
</body>
</html>
'''

# ---------------------------
# Helper: server-side fetch from NewsData
# ---------------------------
def fetch_from_newsdata(category='top', country='us', limit=12):
    try:
        params = {
            'apikey': NEWSDATA_API_KEY,
            'language': 'en',
            'country': country,
            'page': 1,
            'page_size': limit
        }

        # map our simple category to newsdata categories if provided
        if category and category != 'top':
            params['category'] = category

        resp = requests.get(NEWSDATA_ENDPOINT, params=params, timeout=10)
        resp.raise_for_status()
        data = resp.json()

        # NewsData returns 'results' list of articles
        articles = data.get('results') or []
        # Normalize some fields so frontend has consistent keys
        normalized = []
        for a in articles:
            normalized.append({
                'title': a.get('title'),
                'description': a.get('description') or a.get('summary') or '',
                'image_url': a.get('image_url') or a.get('image') or '',
                'link': a.get('link') or a.get('url') or '',
                'source': a.get('source_id') or (a.get('source') and (a['source'].get('name') if isinstance(a['source'], dict) else a['source'])) or '',
                'creator': a.get('creator'),
                'pubDate': a.get('pubDate') or a.get('pubDateIso') or a.get('pubDate_z') or ''
            })
        return {'status':'ok', 'articles': normalized, 'raw': data}
    except Exception as e:
        # return empty list on error (frontend shows friendly message)
        traceback.print_exc()
        return {'status':'error', 'error': str(e), 'articles': []}

# ---------------------------
# Routes
# ---------------------------
@app.route('/')
def index():
    # render the single embedded HTML template
    return render_template_string(HTML_TEMPLATE)

@app.route('/api/news')
def api_news():
    category = request.args.get('category', 'top')
    limit = request.args.get('limit', 12)
    try:
        limit = int(limit)
        if limit <= 0 or limit > 50:
            limit = 12
    except:
        limit = 12

    result = fetch_from_newsdata(category=category, limit=limit)
    return jsonify(result)

# ---------------------------
# Run server
# ---------------------------
if __name__ == '__main__':
    # For local development only: debug True. For production, use gunicorn or BursaLab, Render, etc.
    print("Starting Bright as News (Flask) - Made by Sahitya. 2026")
    print("Open http://127.0.0.1:5000 in your browser.")
    app.run(host='0.0.0.0', port=5000, debug=True)
